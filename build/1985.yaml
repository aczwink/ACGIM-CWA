steps:
  #addons
  - type: RepackArchive
    sourceLocation: cwa_installer
    source:
      type: Archive
      name: CWA.exe
      pbo: .rsrc/0/RCDATA/CWA\ADDONS\6G30.PBO.XZ
    exclude: [config.bin, stringtable.csv]
    include:
      - source: source
        path: AddOns/6G30/config.cpp
    targetPboName: 6G30

  - type: RepackArchive
    sourceLocation: cwa_installer
    source:
      type: Archive
      name: CWA.exe
      pbo: .rsrc/0/RCDATA/CWA\ADDONS\ABOX.PBO.XZ
    exclude: [config.bin, stringtable.csv]
    include:
      - source: source
        path: AddOns/ABox/config.cpp
    targetPboName: ABox

  - type: RepackArchive
    sourceLocation: cwa_installer
    source:
      type: Archive
      name: CWA.exe
      pbo: .rsrc/0/RCDATA/CWA\ADDONS\APAC.PBO.XZ
    exclude: [config.bin, stringtable.csv]
    include:
      - source: source
        path: AddOns/Apac/config.cpp
    targetPboName: Apac

  - type: RepackArchive
    sourceLocation: cwa_patch
    source:
      type: Archive
      name: CWA_update.22112011-combinedALL.7z
      pbo: Addons/BISCamel.pbo
    exclude: [config.bin, stringtable.csv]
    include:
      - source: source
        path: AddOns/BISCamel/config.cpp
    targetPboName: BISCamel

  - type: RepackArchive
    sourceLocation: cwa_installer
    source:
      type: Archive
      name: CWA.exe
      pbo: .rsrc/0/RCDATA/CWA\ADDONS\BIZON.PBO.XZ
    exclude: [config.bin, dx6.log, stringtable.csv]
    include:
      - source: source
        path: AddOns/Bizon/config.cpp
    targetPboName: Bizon

  - type: RepackArchive
    sourceLocation: cwa_installer
    source:
      type: Archive
      name: CWA.exe
      pbo: .rsrc/0/RCDATA/CWA\ADDONS\BMP2.PBO.XZ
    exclude: [config.bin, stringtable.csv]
    include:
      - source: source
        path: AddOns/BMP2/config.cpp
    targetPboName: BMP2

  - type: RepackArchive
    sourceLocation: cwa_installer
    source:
      type: Archive
      name: CWA.exe
      pbo: .rsrc/0/RCDATA/CWA\ADDONS\BRMD.PBO.XZ
    exclude: [config.bin, stringtable.csv]
    include:
      - source: source
        path: AddOns/Brmd/config.cpp
    targetPboName: Brmd

  - type: RepackArchive
    sourceLocation: cwa_installer
    source:
      type: Archive
      name: CWA.exe
      pbo: .rsrc/0/RCDATA/CWA\ADDONS\CH47.PBO.XZ
    exclude: [config.bin, config.cpp, CH47-D.backup, stringtable.csv]
    include:
      - source: source
        path: AddOns/ch47/config.cpp
    targetPboName: ch47

  - type: RepackArchive
    sourceLocation: cwa_installer
    source:
      type: Archive
      name: CWA.exe
      pbo: .rsrc/0/RCDATA/CWA\ADDONS\G36A.PBO.XZ
    exclude: [config.bin, stringtable.csv]
    include:
      - source: source
        path: AddOns/G36a/config.cpp
    targetPboName: G36a

  - type: RepackArchive
    sourceLocation: cwa_installer
    source:
      type: Archive
      name: CWA.exe
      pbo: .rsrc/0/RCDATA/CWA\ADDONS\HUMR.PBO.XZ
    exclude: [config.bin, stringtable.csv]
    include:
      - source: source
        path: AddOns/humr/config.cpp
    targetPboName: humr

  - type: RepackArchive
    sourceLocation: cwa_installer
    source:
      type: Archive
      name: CWA.exe
      pbo: .rsrc/0/RCDATA/CWA\ADDONS\HUNTER.PBO.XZ
    exclude: [config.bin, stringtable.csv, vssver.scc]
    include:
      - source: source
        path: AddOns/Hunter/config.cpp
    targetPboName: Hunter


  - type: CopyFiles
    source: resources
    files: AddOns/*.pbo #TODO: check this, I think these are just copies of the original addon files but without the config.cpp/config.bin/stringtable.csv. This could be done with a unpack-delete config-repack step

  #bin
  - type: CompileConfig
    source: source
    sourceFile: Bin/Config.cpp
    targetFolder: Bin

  - type: CompileConfig
    source: source
    sourceFile: Bin/Resource.cpp
    targetFolder: Bin

  - type: CopyFiles
    source: source
    files: Bin/STRINGTABLE.CSV


  #dta
  - type: ImportFiles
    source: addons
    ignore: [data, data3d, o]
    sources:
      - type: FileSystem
        source: source
        files:
          - Models/CSLA2_M16A2_optika_sd.p3d
          
      - type: Archive
        name: CSLA2Update2_Install_v220.exe
        pbos:
          - CSLA/Addons/csla_arm.pbo
          - CSLA/Addons/csla_us.pbo
        files:
          - csla_us/CSLA2_M16A2_optika.p3d
          - csla_us/CSLA2_UH60A.p3d
          - csla_us/CSLA2_UH60A_M2.p3d
          - csla_us/uh-60a/ps_sklo.paa
          - csla_us/uh-60a/ps_sklo2.paa
          - csla_us/uh-60a/ps_sklo3.paa
          - csla_us/uh-60a/zp_sklo.paa
          - csla_us/uh-60a/zp_sklo2.paa
          - csla_us/uh-60a/zp_sklo3.paa
          - csla_us/uh-60a/po_sklo.paa
          - csla_us/uh-60a/po_sklo2.paa
          - csla_us/uh-60a/po_sklo3.paa
          - csla_us/uh-60a/pp_sklo.paa
          - csla_us/uh-60a/pp_sklo2.paa
          - csla_us/uh-60a/pp_sklo3.paa

      - type: Archive
        name: FFUR_85_Patch_1.05.exe
        pbos:
          - "@ffsx85/addons/Noe.pbo"
          - "@ffsx85/addons/SLX_Grass.pbo"
          - "@ffsx85/addons/SLX_Grass_CWC_Islands.pbo"
        files:
          - Noe/noe.wrp
          - SLX_Grass_CWC_Islands/Abel.wrp
          - SLX_Grass_CWC_Islands/cain.wrp
          - SLX_Grass_CWC_Islands/Eden.wrp

      - type: Archive
        name: RHS_weapons_v1.01.rar
        pbos:
          - RHS_SVD.pbo
          - RHS_Weap.pbo
        files:
          - RHS_SVD/rhs_svd.p3d
          - { sourceFileName: RHS_Weap/AK_Optics/AK_Optic2.p3d, targetName: rhs_AK_Optic2 }

      - type: Archive
        name: INQ_M60.rar
        pbos:
          - INQ_M60.pbo
        files:
          - { sourceFileName: INQ_M60/sounds/Engine_Start.ogg, targetName: m60_Engine_Start }

      - type: Archive
        name: rus_zsu.rar
        pbos:
          - MNF_ZSU.pbo
        files:
          - { sourceFileName: MNF_ZSU/23mm.p3d, targetName: zsu234_23mm }
          - { sourceFileName: MNF_ZSU/sounds/eng1.ogg, targetName: zsu234_eng1 }
          - { sourceFileName: MNF_ZSU/sounds/engineoff.ogg, targetName: zsu234_engineoff }

      - type: Archive
        name: SFM_URALS.rar
        pbos:
          - SFM_URALS.pbo
        files:
          - SFM_URALS/anim/DLEMuralDEADCARGO1.rtm
          - SFM_URALS/ural4320_closed.p3d
          - SFM_URALS/ural4320_dead.p3d
          - SFM_URALS/ural4320_GAS.p3d
          - SFM_URALS/ural4320_GAS_dead.p3d
          - SFM_URALS/ural375_dead_bag.p3d
          - SFM_URALS/ural375_dead_dver.p3d
          - SFM_URALS/ural375_dead_dverL.p3d
          - SFM_URALS/ural375_dead_jasik.p3d
          - SFM_URALS/ural375_dead_koles.p3d
          - SFM_URALS/ural375_dead_palki1.p3d
          - SFM_URALS/ural375_dead_palki2.p3d
          - SFM_URALS/ural375_dead_zerk.p3d
          - SFM_URALS/Ural_dead_cist.p3d

  - type: BuildDtaExt
    sourceLocation: source_equip
    id_map:
      source: source
      filePath: Bin/Config/CfgWeapons/BISClassesRenames.hpp
      regExp: "^#define\\s+(?<from>[A-Z][a-zA-Z0-9_]+)\\s+(?<to>[A-Z][a-zA-Z0-9]+)$"
    imageSources:
      - type: Archive
        sourceLocation: cwa_installer
        name: CWA.exe
        pbos:
          - .rsrc/0/RCDATA/CWA\DTA\DTAEXT.PBO.XZ
        files:
          - { sourceFileName: CWA\DTA\DTAEXT.PBO/equip/m/m_handgrenade.paa, type: magazine, targetName: HandGrenade }
          - { sourceFileName: CWA\DTA\DTAEXT.PBO/equip/m/m_mine.paa, type: magazine, targetName: Mine }
          - { sourceFileName: CWA\DTA\DTAEXT.PBO/equip/m/m_pipebomb.paa, type: magazine, targetName: PipeBomb }
          - { sourceFileName: CWA\DTA\DTAEXT.PBO/equip/w/w_binocular.paa, type: weapon, targetName: Binocular }
          - { sourceFileName: CWA\DTA\DTAEXT.PBO/equip/w/w_nvgoggles.paa, type: weapon, targetName: NVGoggles }
          - { sourceFileName: CWA\DTA\DTAEXT.PBO/equip/emptyeq.paa, type: base, targetName: emptyeq }
          - { sourceFileName: CWA\DTA\DTAEXT.PBO/equip/emptygun.paa, type: base, targetName: emptygun }
          - { sourceFileName: CWA\DTA\DTAEXT.PBO/equip/emptymag.paa, type: base, targetName: emptymag }
          - { sourceFileName: CWA\DTA\DTAEXT.PBO/equip/emptymag2.paa, type: base, targetName: emptymag2 }
          - { sourceFileName: CWA\DTA\DTAEXT.PBO/equip/emptysec.paa, type: base, targetName: emptysec }

      - type: Archive
        sourceLocation: addons
        name: BD Grenade Pack v3.3.rar
        pbos:
          - BD_GrenadePack.pbo
        files:
          - { sourceFileName: BD_GrenadePack/inv/ANM8.paa, type: magazine, targetName: ANM8 }
          - { sourceFileName: BD_GrenadePack/inv/M18G.paa, type: magazine, targetName: M18Green }
          - { sourceFileName: BD_GrenadePack/inv/M18R.paa, type: magazine, targetName: M18Red }
          - { sourceFileName: BD_GrenadePack/inv/M67.paa, type: magazine, targetName: M67 }
          - { sourceFileName: BD_GrenadePack/inv/RDG1W.paa, type: magazine, targetName: RDG1 }
          - { sourceFileName: BD_GrenadePack/inv/RGO.paa, type: magazine, targetName: RGO }

      - type: Archive
        sourceLocation: addons
        name: CBT_MISC_v1.2.rar
        pbos:
          - CBT_Misc.pbo
        files:
          - { sourceFileName: CBT_Misc/jav/gear2.paa, type: magazine, targetName: M47Dragon }
          - { sourceFileName: CBT_Misc/jav/gear1.paa, type: weapon, targetName: M47Dragon }

      - type: Archive
        sourceLocation: addons
        name: icprpg.rar
        pbos:
          - ICPrpg7.pbo
        files:
          - { sourceFileName: ICPrpg7/gearv1.paa, type: weapon, targetName: RPG7V }

      - type: Archive
        sourceLocation: addons
        name: LSR_US_Weapons_Pack_300.rar
        pbos:
          - LSR_US_Weapons_Pack_300/LSR_uswp.pbo
        files:
          - { sourceFileName: LSR_uswp/weapics/w_m60.paa, type: weapon, targetName: M60 }

      - type: Archive
        sourceLocation: addons
        name: RHS_weapons_v1.01.rar
        pbos:
          - RHS_Weap.pbo
        files:
          - { sourceFileName: "RHS_Weap/AK_Pics/m_30RD_5,45_MAG.paa", type: magazine, targetName: AK74 }
          - { sourceFileName: RHS_Weap/AK_Pics/w_AK74.paa, type: weapon, targetName: AK74 }

      - type: Archive
        sourceLocation: addons
        name: SJB_WeaponsPack_v1.1.cab
        pbos:
          - SJB_WeaponsPack_v1.1/SJB_TOSM4.pbo
        files:
          - { sourceFileName: SJB_TOSM4/inventory/w_car15.paa, type: weapon, targetName: CAR15 }
          - { sourceFileName: SJB_TOSM4/inventory/m_m4a1.paa, type: magazine, targetName: CAR15_SD }
          - { sourceFileName: SJB_TOSM4/inventory/w_car15_sd.paa, type: weapon, targetName: CAR15_SD }
          - { sourceFileName: SJB_TOSM4/inventory/m_m4a1.paa, type: magazine, targetName: M16A2 }
          - { sourceFileName: SJB_TOSM4/inventory/w_m16a2.paa, type: weapon, targetName: M16A2 }
          - { sourceFileName: SJB_TOSM4/inventory/w_m16a2_m203.paa, type: weapon, targetName: M16A2_M203 }
          - { sourceFileName: SJB_TOSM4/inventory/m_pistolmag.paa, type: magazine, targetName: M1911 }
          - { sourceFileName: SJB_TOSM4/inventory/w_colt1911.paa, type: weapon, targetName: M1911 }
          - { sourceFileName: SJB_TOSM4/inventory/m_pistolmag.paa, type: magazine, targetName: M1911_SD }
          - { sourceFileName: SJB_TOSM4/inventory/w_colt1911_sd.paa, type: weapon, targetName: M1911_SD }
          - { sourceFileName: SJB_TOSM4/inventory/m_m21.paa, type: magazine, targetName: M21 }
          - { sourceFileName: SJB_TOSM4/inventory/w_m21.paa, type: weapon, targetName: M21 }
          - { sourceFileName: SJB_TOSM4/inventory/w_m21_camo.paa, type: weapon, targetName: M21_JungleCamo }

  - type: CopyFiles
    source: resources
    files: Dta/*.pbo #TODO: these should be packed instead of copied

  - type: PackArchive
    source: source
    source_folder: Scripts
    target_folder: Dta
    targetFileName: acgim_scripts

  - type: PackArchive
    source: resources
    source_folder: Dta/d4t_files
    target_folder: Dta

  - type: PackArchive
    source: resources
    source_folder: Dta/d4t_tex
    target_folder: Dta

  - type: PackArchive
    source: resources
    source_folder: Dta/sjc_anims
    target_folder: Dta

  - type: PackArchive
    source: resources
    source_folder: Dta/sjc_files
    target_folder: Dta

  - type: PackArchive
    source: resources
    source_folder: Dta/sjc_models
    target_folder: Dta

  - type: PackArchive
    source: resources
    source_folder: Dta/SJC_Scripts
    target_folder: Dta

  - type: PackArchive
    source: resources
    source_folder: Dta/sjc_textures
    target_folder: Dta

  #misc
  - type: CopyFiles
    source: source
    files: [LICENSE, README.md, Start.bat, Start Windowed.bat, Used Addons.md]

  - type: Create7zArchive